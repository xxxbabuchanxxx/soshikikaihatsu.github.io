# 匿名ユーザー識別システム - 実装完了報告

## 改善内容

「メールアドレス入力が面倒」という問題を解決するため、**匿名ユーザーIDによる自動識別システム**を実装しました。

## 変更点

### Before（変更前）
```
ページを開く
  ↓
メールアドレスを入力してください 😓
  ↓
名前を入力してください 😓
  ↓
ようやく使える...
```

### After（変更後）
```
ページを開く
  ↓
即座に使える！ 😊
  ↓
（バックグラウンドで自動的にユーザーIDを生成）
```

## 技術的な実装

### 1. 匿名ユーザーIDの生成 (`js/config.js`)

**特徴:**
- **完全自動**: ユーザー入力不要
- **永続的**: ブラウザを閉じても保持される
- **ユニーク**: 各ユーザーを一意に識別

**生成ロジック:**
```javascript
function generateUserId() {
    // 1. タイムスタンプ（いつ生成されたか）
    const timestamp = new Date().getTime();
    
    // 2. ランダム文字列（衝突回避）
    const random = Math.random().toString(36).substring(2, 15);
    
    // 3. ブラウザフィンガープリント（端末識別）
    const fingerprint = getBrowserFingerprint();
    
    // 結合
    return `USER_${timestamp}_${random}_${fingerprint}`;
}
```

**生成例:**
```
USER_1737015123456_abc123xyz789_4f8a9b2c
```

### 2. ブラウザフィンガープリント (`js/config.js`)

複数の要素を組み合わせて、ブラウザ/端末を識別します:

```javascript
function getBrowserFingerprint() {
    const components = [
        navigator.userAgent,      // ブラウザ情報
        navigator.language,        // 言語設定
        screen.colorDepth,         // 画面の色深度
        screen.width + 'x' + screen.height,  // 画面解像度
        new Date().getTimezoneOffset(),      // タイムゾーン
        !!window.sessionStorage,   // ストレージ対応
        !!window.localStorage      // ストレージ対応
    ].join('###');
    
    // ハッシュ化して8文字のIDに変換
    return hash(components);
}
```

### 3. LocalStorageによる永続化

```javascript
function getAnonymousUserId() {
    const STORAGE_KEY = 'ssap_anonymous_user_id';
    
    // 既存のIDがあれば返す
    let userId = localStorage.getItem(STORAGE_KEY);
    
    if (!userId) {
        // 新規ユーザー: ユニークIDを生成
        userId = generateUserId();
        localStorage.setItem(STORAGE_KEY, userId);
    }
    
    return userId;
}
```

### 4. proposals.jsの変更

メールアドレス入力プロンプトを削除し、自動的にIDを取得:

```javascript
// Before
userEmail = prompt('メールアドレスを入力してください:');

// After
userEmail = getAnonymousUserId(); // 自動生成！
```

## メリット

### 1. ユーザーエクスペリエンス
- ✅ **即座に使える**: 入力不要
- ✅ **プライバシー保護**: 個人情報不要
- ✅ **手間なし**: 面倒な入力が一切なし

### 2. 技術的メリット
- ✅ **重複投票防止**: 同一ユーザーは1回のみ投票可能
- ✅ **永続的識別**: ページをリロードしても同じID
- ✅ **オフライン動作**: サーバー通信不要でID生成

### 3. セキュリティ
- ✅ **個人情報なし**: メールアドレス等を収集しない
- ✅ **GDPR対応**: 個人を特定できない
- ✅ **完全匿名**: プライバシー保護

## IPアドレスではなくブラウザフィンガープリントを選んだ理由

### IPアドレスの問題点

| 項目 | IPアドレス | ブラウザフィンガープリント |
|------|-----------|--------------------------|
| **取得可能性** | ❌ JavaScriptから取得不可 | ✅ 取得可能 |
| **GASでの取得** | ❌ GoogleサーバーIPのみ | ✅ 不要（クライアント側で完結） |
| **プライバシー** | ❌ 個人を特定しやすい | ✅ 匿名性が高い |
| **動的IP** | ❌ IPが変わると別ユーザー扱い | ✅ 端末が同じなら識別可能 |
| **社内利用** | ❌ 同じIPで複数人が使うと識別不可 | ✅ 各ブラウザで識別可能 |

### ブラウザフィンガープリントの利点

1. **技術的に実現可能**
   - JavaScriptで完全に実装可能
   - 外部APIやサーバー処理不要

2. **永続的**
   - 同じブラウザ・端末なら常に同じID
   - Cookieを削除しても識別可能（フィンガープリント部分）

3. **プライバシー保護**
   - 個人を特定する情報を含まない
   - GDPR等のプライバシー規制に対応

4. **社内環境に最適**
   - 同じIPアドレスの社内でも各PCを識別可能
   - VPN使用時も問題なし

## ユーザーIDの構成

```
USER_1737015123456_abc123xyz789_4f8a9b2c
│    │              │            │
│    │              │            └─ ブラウザフィンガープリント（8文字）
│    │              └────────────── ランダム文字列（13文字）
│    └─────────────────────────── タイムスタンプ（13桁）
└──────────────────────────────── プレフィックス
```

### 各要素の役割

1. **タイムスタンプ**: いつ生成されたか（重複防止）
2. **ランダム文字列**: 同時刻の衝突回避
3. **フィンガープリント**: 端末/ブラウザの識別

## データの保存場所

### LocalStorage
```javascript
Key: 'ssap_anonymous_user_id'
Value: 'USER_1737015123456_abc123xyz789_4f8a9b2c'
```

### スプレッドシート（いいねユーザーリスト列）
```
USER_1737015123456_abc123xyz789_4f8a9b2c,USER_1737015234567_def456uvw012_5g9b0c3d,...
```

## 動作確認

### 1. 初回アクセス時
1. `proposals.html` を開く
2. ブラウザコンソール（F12）を確認
3. `🆔 ユーザーID: USER_...` が表示される
4. LocalStorageを確認（開発者ツール → Application → Local Storage）

### 2. 2回目以降
1. ページをリロード
2. 同じユーザーIDが表示される（永続的）

### 3. いいね機能のテスト
1. 提案にいいねをクリック
2. 同じ提案に再度いいねをクリック
3. 「既にいいね済みです」とエラーが表示される ← 正常動作！

### 4. 別のブラウザでテスト
1. Chrome で提案にいいね
2. Firefox で同じ提案にいいね
3. 別ユーザーとして認識され、両方いいねできる ← 正常動作！

### 5. シークレットモードでテスト
1. シークレットモードで開く
2. 通常モードとは別のユーザーIDが生成される
3. 別ユーザーとして動作する

## 注意点

### ユーザーIDがリセットされるケース

1. **ブラウザのLocalStorageをクリア**
   - 設定 → プライバシー → 閲覧データの削除
   - 新しいIDが生成される

2. **シークレット/プライベートモード**
   - 通常モードとは別のID
   - ウィンドウを閉じるとリセット

3. **別のブラウザを使用**
   - Chrome と Firefox は別ユーザー

4. **別のPCを使用**
   - 当然別ユーザー

### これらは想定内の動作です

- LocalStorageをクリアする ≒ 別ユーザーとして使いたい
- シークレットモード ≒ 一時的な利用
- 別のブラウザ/PC ≒ 別ユーザー

## セキュリティとプライバシー

### 収集する情報
- ✅ 自動生成されたランダムID（個人を特定できない）
- ✅ ブラウザの基本情報（User-Agent等、一般公開情報）

### 収集しない情報
- ❌ 名前
- ❌ メールアドレス
- ❌ 電話番号
- ❌ IPアドレス
- ❌ 位置情報

### GDPR対応
- 個人を特定できる情報（PII）を一切収集しない
- 匿名データのみ使用
- ユーザーの同意不要（個人情報ではないため）

## まとめ

今回の改善により:

1. ✅ **メールアドレス入力が不要**になった
2. ✅ **即座に使える**ようになった
3. ✅ **プライバシーが保護**される
4. ✅ **重複投票は防止**される
5. ✅ **技術的に実現可能**で信頼性が高い

**結果: ユーザーフレンドリーで、プライバシーも保護される匿名投票システムが実現！**

## トラブルシューティング

### Q: いいねができない
**A:** LocalStorageが無効になっている可能性があります。ブラウザの設定を確認してください。

### Q: ページをリロードすると別ユーザーになる
**A:** シークレットモードを使用していませんか？通常モードをご利用ください。

### Q: 同じPCで複数人が使う場合は？
**A:** ブラウザを変えるか、シークレットモードを使うことで別ユーザーとして識別できます。

---

**実装日**: 2026年1月15日  
**開発者**: 組織開発課
